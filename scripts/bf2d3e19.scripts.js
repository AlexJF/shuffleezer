"use strict";var shuffleezerApp=angular.module("shuffleezerApp",["ngSanitize","oauth","ngRoute","deezerServices","ui.select","ui.bootstrap","truncate"]);shuffleezerApp.config(["$routeProvider","$locationProvider","uiSelectConfig",function(a,b,c){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0).hashPrefix("!"),c.theme="bootstrap"}]);var shuffleezerApp=angular.module("shuffleezerApp");shuffleezerApp.controller("MainCtrl",["$scope","$http","$location","DeezerProfile","DeezerPlaylist","AccessToken","$modal","$q","$rootScope",function(a,b,c,d,e,f,g,h,i){function j(c,e){i.profile||(console.log("AccessToken: "+f.get().access_token),d.load().then(function(c){i.profile||(i.profile=d.get(),console.log("Load profile success"),console.log(i.profile),b.defaults.headers.common.Authorization="Bearer "+f.get().access_token,a.loadDeezerData())},function(a){console.log("Error loading profile: "+a),i.$broadcast("oauth:expired")}))}function k(){null!=i.profile&&(console.log("Forget profile: "+i.profile),i.profile=null,b.defaults.headers.common.Authorization=null,f.destroy())}function l(){var b=[],c=0;a.selectionData.sources.forEach(function(a){for(var d=0;d<a.total;++d)b.push(c++)});var d=window.chance.pick(b,a.selectionData.totalSongsInDestination);d.sort(function(a,b){return a-b});var f=d.length,g=0,h=0,i=[];return a.selectionData.sources.forEach(function(b){for(var c=b.total,j=[];f>h;){var k=d[h]-g;if(k>=c)break;j.push(k),++h}g+=c,i.push(e.getPlaylistTracks(b.id,j).then(null,null,function(b){a.$broadcast("progress:tracks_read",b.delta)}))}),i}function m(){var b=[];return a.selectionData.sources.forEach(function(c){b.push(e.getPlaylistTracks(c.id).then(null,null,function(b){a.$broadcast("progress:tracks_read",b.delta)}))}),b}a.host=c.host(),a.localhost="127.0.0.1"==a.host||"localhost"==a.host,i.deezerData={playlists:[]},a.selectionData={sources:[],totalSongsInSources:0,destination:null,totalSongsInDestination:0,maxSongsDestination:null,ensureUnique:!0},a.newPlaylistName="",i.profile=null,i.gettingPlaylists=!1,a.$on("oauth:logout",k),a.$on("oauth:expired",k),a.$on("oauth:denied",k),a.$on("oauth:authorized",j),a.loadDeezerData=function(){i.deezerData.playlists.length>0||i.gettingPlaylists||(i.gettingPlaylists=!0,e.getPlaylistsInfo(!0).then(function(a){i.deezerData.playlists=a,i.gettingPlaylists=!1}))},a.$watchCollection("selectionData.sources",function(){var b=0;a.selectionData.sources.forEach(function(a){b+=a.total}),a.selectionData.totalSongsInSources=b}),a.$watchCollection("[selectionData.totalSongsInSources, selectionData.maxSongsDestination]",function(){var b=a.selectionData.maxSongsDestination,c=a.selectionData.totalSongsInSources;!b&&0!==b||0>b?a.selectionData.totalSongsInDestination=c:a.selectionData.totalSongsInDestination=Math.min(b,c)}),a.selectAllSources=function(){a.selectionData.sources=angular.extend(i.deezerData.playlists)},a.clearSourcesSelection=function(){a.selectionData.sources=void 0};var n=["$scope","$modalInstance","selectionData",function(a,b,c){a.selectionData=c,a.playlistInfo={name:null},a.ok=function(){e.addPlaylist(a.playlistInfo.name).then(function(a){console.log(a),b.close(a)})},a.cancel=function(){b.dismiss("cancel")}}];a.addPlaylist=function(b){var c=g.open({templateUrl:"views/add_playlist.html",controller:n,windowClass:"add-playlist-dialog",resolve:{selectionData:function(){return a.selectionData}}});c.result.then(function(b){a.selectionData.destination=b})};var o=["$scope","$modalInstance","selectionData",function(a,b,c){a.selectionData=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}],p=["$scope","$modalInstance","selectionData",function(a,b,c){a.selectionData=c,a.progressData={phase:0,total_songs_to_read:a.selectionData.ensureUnique?a.selectionData.totalSongsInSources:a.selectionData.totalSongsInDestination,total_songs_to_write:a.selectionData.totalSongsInDestination,num_tracks_read:0,num_tracks_written:0,percent_tracks_read:0,percent_tracks_written:0,finished_read:!1,finished_write:!1,finished_clear:!1,write_error:null,read_error:null,clear_error:null},a.$watchCollection("[progressData.num_tracks_read, progressData.total_songs_to_read]",function(){a.progressData.percent_tracks_read=a.progressData.num_tracks_read/a.progressData.total_songs_to_read*100}),a.$watchCollection("[progressData.num_tracks_written, progressData.total_songs_to_write]",function(){a.progressData.percent_tracks_written=a.progressData.num_tracks_written/a.progressData.total_songs_to_write*100}),a.$on("progress:tracks_read",function(b,c){a.progressData.num_tracks_read+=c}),a.$on("progress:finished_read",function(){a.progressData.finished_read=!0,a.progressData.phase++}),a.$on("progress:finished_clear",function(){a.progressData.phase++}),a.$on("progress:tracks_written",function(b,c){console.log(c),console.log(a.progressData),a.progressData.num_tracks_written+=c}),a.$on("progress:finished_write",function(){a.progressData.finished_write=!0,a.progressData.phase++}),a.$on("progress:read_error",function(b,c){a.progressData.read_error=c}),a.$on("progress:write_error",function(b,c){a.progressData.write_error=c}),a.$on("progress:clear_error",function(b,c){a.progressData.clear_error=c}),a.$on("progress:new_total_write_count",function(b,c){console.log("Old total write count: "+a.progressData.total_songs_to_write),console.log("New total write count: "+c),a.progressData.total_songs_to_write=c}),a.ok=function(){b.close()}}];a.showConfirmDialog=function(){var b=g.open({templateUrl:"views/confirm.html",controller:o,windowClass:"confirm-dialog",resolve:{selectionData:function(){return a.selectionData}}});b.result.then(function(){var b=(g.open({templateUrl:"views/progress.html",controller:p,windowClass:"progress-dialog",backdrop:"static",keyboard:!1,scope:a,resolve:{selectionData:function(){return a.selectionData}}}),a.selectionData.totalSongsInSources==a.selectionData.totalSongsInDestination),c=a.selectionData.ensureUnique,d=null;d=b||c?m():l(),h.all(d).then(function(b){a.$broadcast("progress:finished_read");var d=[];b.forEach(function(a){d=d.concat(a)}),d=d.filter(function(a){return"spotify:track:null"!=a}),c&&(d=d.sort().filter(function(a,b){return!b||a!=d[b-1]}),a.$broadcast("progress:new_total_write_count",d.length)),d.length>a.selectionData.totalSongsInDestination?(d=window.chance.pick(d,a.selectionData.totalSongsInDestination),a.$broadcast("progress:new_total_write_count",d.length)):d=window.chance.shuffle(d),console.log("SelectionData.destination"),console.log(a.selectionData.destination),e.clearPlaylist(a.selectionData.destination.id).then(function(b){console.log("#################"),console.log(b),a.$broadcast("progress:finished_clear"),e.addPlaylistTracks(a.selectionData.destination.id,d).then(function(b){a.$broadcast("progress:finished_write"),console.log("Success")},function(b){console.log("Write error: "+b),a.$broadcast("progress:write_error",b)},function(b){a.$broadcast("progress:tracks_written",b.delta)})},function(b){console.log("Clear error: "+b),a.$broadcast("progress:clear_error",b)})},function(b){console.log("Read error: "+b),a.$broadcast("progress:read_error",b)},function(a){})})}}]);var deezerServices=angular.module("deezerServices",["oauth"]);deezerServices.factory("DeezerRequester",["$http","AccessToken","$q",function(a,b,c){function d(a,c){var d=b.get().access_token,e=new Url(a);return e.query.callback=f,e.query.access_token=d,e.query.output="jsonp",Object.keys(c).forEach(function(a){e.query[a]=c[a]}),e.toString()}function e(b){return function(e,f){f=f||{},f.request_method=b;var g=d(e,f);return a.jsonp(g).then(function(a){return a.data.error?c.reject(a.data.error.message):a},function(a){return c.reject(a)})}}var f="JSON_CALLBACK";return{get:e("get"),post:e("post"),"delete":e("delete")}}]),deezerServices.factory("DeezerProfile",["$q","DeezerRequester",function(a,b){function c(c){return null==e||c?b.get("https://api.deezer.com/user/me").then(function(a){return e=a.data,a},function(b){return a.reject(b)}):void 0}function d(){return e}var e=null;return{load:c,get:d}}]),deezerServices.factory("DeezerPlaylist",["$q","DeezerRequester","DeezerProfile",function(a,b,c){function d(a){return{id:a.id,name:a.title,type:"playlist",total:a.nb_tracks,owner:a.creator.id}}function e(c){function e(){b.get(g).then(function(a){a.data.data.forEach(function(a){var b=d(a);n.playlists_info.push(b)}),a.data.next?(g=a.data.next,e()):(m(),f.resolve(n.playlists_info))},function(a){f.reject(a)})}var f=a.defer(),g="https://api.deezer.com/user/me/playlists?limit=50";return n.playlists_info.length>0&&!c?f.resolve(n.playlists_info):(n.playlists_info=[],e()),f.promise}function f(c,d){function e(a){if(a.length<=0)return void g.resolve(h);var c=a.shift();b.get(i,{offset:c.offset,limit:c.limit}).then(function(b){for(var f=0,i=0;i<b.data.data.length;++i)if(i in c.items){var j=b.data.data[i];null!=j.id&&(h.push(j.id),++f)}else console.log("Skipping "+i);g.notify({delta:f,current:h.length,total:d.length}),e(a)},function(a){g.reject(a)})}function f(){b.get(i).then(function(a){var b=0;a.data.data.forEach(function(a){null!=a.id&&(h.push(a.id),++b)}),g.notify({delta:b,current:h.length,total:a.total}),a.data.next?(i=a.data.next,f()):g.resolve(h)},function(a){g.reject(a)})}var g=a.defer(),h=[],i="https://api.deezer.com/playlist/"+c+"/tracks";if(d){var j=[],k=null,l=100;d.forEach(function(a){k&&(a-k.offset+1>l?(j.push(k),k=null):(k.limit=a-k.offset+1,k.items.push(a-k.offset))),k||(k={offset:a,limit:1,items:[0]})}),k&&j.push(k),e(j)}else f();return g.promise}function g(b){return f(b).then(function(a){var c=a;return h(b,c)},function(b){return a.reject(b)})}function h(c,d){function e(a){if(a.length<=0)return void g.resolve(i);var c=a.splice(0,f);b["delete"](j,{songs:c.join()}).then(function(b){i+=c.length,g.notify({delta:c.length,current:i,total:h}),e(a)},function(a){g.reject(a)})}var f=50,g=a.defer(),h=d.length,i=0,j="https://api.deezer.com/playlist/"+c+"/tracks";return e(d),g.promise.then(function(a){for(var b=0;b<n.playlists_info.length;++b){var d=n.playlists_info[b];if(d.id==c){d.total=h-i;break}}},function(b){return a.reject(b)})}function i(c,d){function e(a){if(a.length<=0)return void g.resolve(h);var c=a.splice(0,f);b.post(j,{songs:c.join()}).then(function(b){h+=c.length,g.notify({delta:c.length,current:h,total:i}),e(a)},function(a){g.reject(a)})}var f=50,g=a.defer(),h=0,i=d.length,j="https://api.deezer.com/playlist/"+c+"/tracks";return e(d),g.promise.then(function(){for(var a=0;a<n.playlists_info.length;++a){var b=n.playlists_info[a];if(b.id==c){b.total=h;break}}},function(b){return a.reject(b)})}function j(b,c){return g(b).then(function(){return i(b,c)},function(b){return a.reject(b)})}function k(d){var e=(a.defer(),b.post("https://api.deezer.com/user/"+c.get().id+"/playlists",{title:d}));return e.then(function(a){console.log(a);var b={id:a.data.id,name:d,type:"playlist",total:0,owner:c.get().id};return n.playlists_info.push(b),m(),b})}function l(a,b,c){var d=function(b){return c?c(b[a]):b[a]};return function(a,c){var e=d(a),f=d(c);return(f>e?-1:e>f?1:"function"==typeof then?then(a,c):0)*[1,-1][+!!b]}}function m(){n.playlists_info.sort(l("name"))}var n={playlists_info:[]};return{getPlaylistsInfo:e,getPlaylistTracks:f,setPlaylistTracks:j,addPlaylist:k,clearPlaylist:g,addPlaylistTracks:i}}]);